---
title: "R Notebook Ladenöffnungszeiten / Einsatzpläne"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
# activate install if needed
#install.packages("RPostgreSQL")
#install.packages("tidyverse")
#install.packages("dplyr")
```
#Create a connection to the Database
```{r}
require("RPostgreSQL")
library(DBI)
library(tidyverse)
library(dplyr)

# define the database connection string
DB_HOST='server2053.cs.technik.fhnw.ch'
DB_PORT = 5432
DB_DBNAME =  'warenkorb_db' # or'bank_db' 
DB_USERNAME = 'db_user'
DB_PASSWORD = 'db_user_pw'

con <- DBI::dbConnect(
  odbc::odbc(),
  Driver   = "PostgreSQL Unicode(x64)",
  Server   = DB_HOST,
  Database = DB_DBNAME,
  UID      = DB_USERNAME,
  PWD      = DB_PASSWORD,
  Port     = DB_PORT)


# load the PostgreSQL driver
drv <- dbDriver("PostgreSQL")
# connect to the database
con <- dbConnect(drv, dbname = DB_DBNAME,
                 host = DB_HOST, port = DB_PORT,
                 user = DB_USERNAME, password = DB_PASSWORD)
```

```{r}
aisle <- dbGetQuery(con,  "SELECT * From aisle")
department <- dbGetQuery(con,  "SELECT * From department")
orders <- dbGetQuery(con,  "SELECT * From orders")
orders_product_prior <- dbGetQuery(con,  "SELECT * From orders_product_prior")
orders_product_train <- dbGetQuery(con,  "SELECT * From orders_product_train")
product <- dbGetQuery(con,  "SELECT * From product")
```

```{r}
#aisle_db <- tbl(con, "aisle")
```

#Plot orders over 24 hours
```{r}

ggplot(data = orders) + 
  geom_bar(mapping = aes(x = order_hour_of_day))
```  

#Plot orders over 7 days
```{r}
ggplot(data = orders) + 
  geom_bar(mapping = aes(x = order_dow))
```

# Plot orders over 24 hours and 7 days
```{r}
ggplot(data = orders) + 
  geom_bar(mapping = aes(x = order_hour_of_day)) +
  facet_wrap(~ order_dow,  nrow = 3)
```


```{r}

items_per_order <- bind_rows(orders_product_prior, orders_product_train) %>% 
  group_by(orders_id) %>%
  summarise(nr_of_items = last(add_to_cart_order))

ggplot(data = items_per_order) + 
  geom_bar(mapping = aes(x = nr_of_items)) +
  xlab("Items per order") + ylab("Nr of orders") 
```


```{r}

product_sales_per_week <- orders %>%
  group_by(orders_id) %>%
  left_join(select(items_per_order, orders_id, nr_of_items),by="orders_id")

```

```{r}
ggplot(data = product_sales_per_week) + 
  geom_col(mapping = aes(x = order_hour_of_day, y = nr_of_items)) +
  facet_wrap(~ order_dow,  nrow = 3)
```

```{r}
# close the connection (don't forget to cleanup)
dbDisconnect(con)
dbUnloadDriver(drv)
```