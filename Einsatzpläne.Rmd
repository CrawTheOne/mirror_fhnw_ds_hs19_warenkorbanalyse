---
title: "R Notebook LadenÃƒÆ’Ã‚Â¶ffnungszeiten / EinsatzplÃƒÆ’Ã‚Â¤ne"
output:
  html_document:
    df_print: paged
  df_print: paged
  pdf_document: default
---
#Install packages if necessary
```{r}
# activate install if needed
#install.packages("RPostgreSQL")
#install.packages("tidyverse")
#install.packages("dplyr")
#install.packages("RColorBrewer")
```

#install libraries
```{r}
require("RPostgreSQL")
library(DBI)
library(tidyverse)
library(dplyr)
library(RColorBrewer)
```

#Create a connection to the Database
```{r}
# define the database connection string
DB_HOST='server2053.cs.technik.fhnw.ch'
DB_PORT = 5432
DB_DBNAME =  'warenkorb_db' # or'bank_db' 
DB_USERNAME = 'db_user'
DB_PASSWORD = 'db_user_pw'

con <- DBI::dbConnect(
  odbc::odbc(),
  Driver   = "PostgreSQL Unicode(x64)",
  Server   = DB_HOST,
  Database = DB_DBNAME,
  UID      = DB_USERNAME,
  PWD      = DB_PASSWORD,
  Port     = DB_PORT)


# load the PostgreSQL driver
drv <- dbDriver("PostgreSQL")
# connect to the database
con <- dbConnect(drv, dbname = DB_DBNAME,
                 host = DB_HOST, port = DB_PORT,
                 user = DB_USERNAME, password = DB_PASSWORD)
```


#Defines SQL Query
```{r}
aisle <- dbGetQuery(con,  "SELECT * From aisle")
department <- dbGetQuery(con,  "SELECT * From department")
orders <- dbGetQuery(con,  "SELECT * From orders")
orders_product_prior <- dbGetQuery(con,  "SELECT * From orders_product_prior")
orders_product_train <- dbGetQuery(con,  "SELECT * From orders_product_train")
product <- dbGetQuery(con,  "SELECT * From product")
```

#Plots (ggplot2)
##Orders over 24 hours


```{r}
orders_per_hour_per_day <- orders %>%
  group_by(order_dow, order_hour_of_day) %>%
  summarise(nr_of_orders = n())
  
print(ggplot(data = orders_per_hour_per_day) + 
      geom_col(mapping = aes(x = order_hour_of_day, y = nr_of_orders/7)) + 
      ggtitle("Average Nr of orders per hour") )

```  

##Orders over 7 days
```{r}
ggplot(data = orders_per_hour_per_day) + 
  geom_col(mapping = aes(x = order_dow, y = nr_of_orders, fill = as.factor(order_dow))) +
  ggtitle("Average Nr of orders per Day ") +
  labs(fill='order_dow') +
  scale_fill_brewer(palette="Spectral")
  
```


```{r}
ggplot(data = orders) + 
  geom_boxplot(mapping = aes(x = order_dow, y = order_hour_of_day, group = order_dow, fill = as.factor(order_dow))) + 
  scale_fill_brewer(palette="Spectral") +
  labs(fill='order_dow') +
  ggtitle("Boxplot avg distribution of orders over the days over one week ")
```



##Orders over 24 hours and 7 days
```{r}
ggplot(data = orders_per_hour_per_day) + 
  geom_col(mapping = aes(x = order_hour_of_day, y = nr_of_orders, fill = as.factor(order_dow))) + 
  facet_wrap(~ order_dow,  nrow = 3) +
  labs(fill='order_dow') +
  scale_fill_brewer(palette="Spectral")
```


##Nr of items per order
Ziel: Untersuchung der Bestellgrössen.
Falls sehr viele grössere Bestellungen vorhanden sind, können diese den Arbeitsaufwand stark verändern. 

Das arithmetische Mittel über alle Bestellungen liegt bei 10.107 verschiedenen Produkten pro Bestellung.

Das Median über alle Bestellungen liegt bei 8 verschiedenen Produkten pro Bestellung. Die hälfte aller Bestellungen enthällt entsprechend 8 oder Weniger Produkte.

75% aller Bestellungen enthalten 14 oder weniger unterschiedliche Produkte.

Fazit: Um genauere Aussagen über Aussagen zum individuellen Auslastung machen zu können müssen erst die durchschnittlichen Bestellgrössen der einzelnen Stunden und Tage Analysiert werden.
```{r}
#Create a new table with Order_id and nr_of_items per order
items_per_order <- bind_rows(orders_product_prior, orders_product_train) %>% 
  group_by(orders_id) %>%
  summarise(nr_of_items = last(add_to_cart_order))

ggplot(data = items_per_order) + 
  geom_bar(mapping = aes(x = nr_of_items), width=0.9) +
  xlab("Products per order") + ylab("Nr of orders") +
  coord_cartesian(xlim=c(0,75)) +
  ggtitle("Average Nr of products per order") 

mean_order_size <- mean(items_per_order$nr_of_items)
median_order_size <- median(items_per_order$nr_of_items)
max_order_size <- max(items_per_order$nr_of_items)
quantile_order_size <- quantile(items_per_order$nr_of_items)
```


```{r}
product_sales_per_week <- orders %>%
  group_by(orders_id) %>%
  left_join(select(items_per_order, orders_id, nr_of_items),by="orders_id")

```


##Items over 24 hours and 7 days
```{r}
ggplot(data = product_sales_per_week) + 
  geom_col(mapping = aes(x = order_hour_of_day, y = nr_of_items, fill = as.factor(order_dow))) +
  facet_wrap(~ order_dow,  nrow = 3) +
  labs(fill='Day of Week') +
  xlab("Hour of Day") + ylab("Nr of Items") +
  scale_fill_brewer(palette="Spectral")
```

```{r}
products_per_hour_per_day <- orders %>%
  group_by(order_dow, order_hour_of_day) %>%
  left_join(select(bind_rows(orders_product_prior, orders_product_train), orders_id, product_id),by="orders_id") %>%
  summarise(nr_of_products = n())

max_products <- products_per_hour_per_day %>%
  summarise(max_day = max(nr_of_products)) %>%
  summarise(max_week = max(max_day)) 
max_p <- (max_products$max_week)

max_orders <- orders_per_hour_per_day %>%
  summarise(max_day = max(nr_of_orders)) %>%
  summarise(max_week = max(max_day)) 
max_o <- (max_orders$max_week)
```

```{r}

order_product_ratio <- orders_per_hour_per_day %>%
  left_join(products_per_hour_per_day, by = c("order_dow" = "order_dow", "order_hour_of_day" = "order_hour_of_day")) %>%
  mutate(order_product_ratio  = nr_of_products/nr_of_orders, workload_orders = nr_of_orders/max_o, workload_products = nr_of_products/max_p)

```


Aussage: Die grösse der einzelnen Bestellungen beeinflusst direkt den Arbeitsaufwand pro Bestellung
Ziel: Durchschnittliche Bestellgrössen pro Stunde pro Tag. 


Aus dem folgenden Diagramm ist ersichtlich, dass die Bestellgrösse am Wochentagag 0 um 8:00Uhr mit durchschnittlich 11.48 verschiedenen items am grössten ist.

Interessant ist, dass die Bestellgrössen über alle Wochentage von 20:00 bis 23:00 im Schnitt um 2 bis 2.5 items pro Bestellung ansteigen. Eine mögliche Erklärung wäre, dass die Kunden, welche online einkaufen, im Schnitt grössere Bestellungen haben.


```{r}
ggplot(data = order_product_ratio) + 
  geom_line(mapping = aes(x = order_hour_of_day, y = order_product_ratio, color=as.factor(order_dow), group = order_dow), size = 1) +
  ggtitle("Average ratio of products per order")  +
  labs(color='Day of Week') +
  scale_color_brewer(palette="Spectral")
```



```{r}
ggplot(data = order_product_ratio) + 
  geom_line(mapping = aes(x = order_hour_of_day, y = workload_orders, color=as.factor(order_dow), group = order_dow), size = 1) +
  ggtitle("Average ratio orders")  +
  labs(color='Day of Week') +
  scale_color_brewer(palette="Spectral")
```


```{r}
ggplot(data = order_product_ratio) + 
  geom_line(mapping = aes(x = order_hour_of_day, y = workload_products, color=as.factor(order_dow), group = order_dow), size = 1) +
  ggtitle("Average workload")  +
  labs(color='Day of Week') +
  scale_color_brewer(palette="Spectral")
```

```{r echo=TRUE}
ggplot(data = order_product_ratio) + 
  geom_raster(mapping = aes(x = order_hour_of_day, y = order_dow, fill = workload_products)) +
  ggtitle("Average workload")+
  scale_fill_gradientn(colours=c("#000000","#0000FF","#00FF00","#FFFF00","#FF0000","#990000")) +
  labs(fill='Workload')
```

```{r}
deployment_plan <- order_product_ratio %>%
  select(order_dow, order_hour_of_day, workload_products)
deployment_plan
```





#Disconnect from the DB
```{r}
# close the connection (don't forget to cleanup)
dbDisconnect(con)
dbUnloadDriver(drv)
```

#Remove Variables from Global Environement
```{r}
remove(max)
```


