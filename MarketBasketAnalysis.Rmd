---
title: "Market Basket Analysis"
output: html_notebook
---

# Vorbereitungen

## Load libraries and connect to database

```{r, echo=FALSE}
library(arules)
library(arulesViz)

source('DbConnection.R')
```


# Warenkorbanalyse

Wir können mit Market Basket Analysis herausfinden, welche Elemente häufig zusammen gekauft werden. Dazu benutzen wir den Apriori Alghorithmus.

## Schritt 1 - DataSet dem UseCase ausrichten

```{r}
orders_products <- t_orders_product %>%
  left_join(t_products, "product_id") %>%
  select(c(orders_id, product_name))
```

## Schritt 2 - Support berechnen

Der Support ist der Anteil eines bestimmtes Produkt an den Gesamtverkäufen.

Wir brauchen zuerst die Anzahl der gekauften Produkte insgesamt.

```{r}
total_products_bought <- orders_products %>%
  count() %>%
  pull(n) %>%
  as.numeric()
```

Daraus können wir den Support pro Produkt berechnen und danach sortieren. Damit haben wir die Reihenfolge der meistverkauften Produkte incl. des Anteils.

```{r}
t_support <- orders_products %>%
  group_by(product_name) %>%
  summarise(n = n()) %>%
  mutate(support = as.numeric(n)/total_products_bought) %>%
  arrange(desc(support))
```

Als Threshold für den Apriori-Algorithmus können wir nun den Median des Supports bestimmen.

```{r}
t_support
```


```{r}
support_threshold <- t_support %>%
  summarise(median = median(support)) %>%
  pull(median)

support_threshold
```


Für die Warenkorbanalyse benötigen wir die Transaktionen als Key und kommasepariert alle Produkte, welche zu dieser Transaktion gehören.

```{r}
baskets <- t_orders_product %>%
  left_join(t_products, "product_id") %>%
  group_by(orders_id) %>%
  summarise(items = string_agg(product_name, ',')) %>%
  selet(items)
```

Da das relativ viele Daten sind, lohnt es sich diese zwischen zu speichern:

```{r}
write.csv(baskets, file="baskets.csv", row.names = FALSE)
```

Jetzt kann man diese aus der gespeicherten CSV Datei benutzen:

```{r}
transactions <- read.transactions('baskets.csv', format = 'basket', sep=',')
```

```{r}
library("RColorBrewer")
arules::itemFrequencyPlot(transactions,
   topN=30,
   col=brewer.pal(8,'Pastel1'),
   main='Relative Item Frequency Plot',
   type="relative",
   ylab="Item Frequency (Relative)") 
```


```{r}
rules <- transactions %>%
  apriori(parameter = list(support = 0.005, confidence = 0.25))
```

```{r}
rules_tib <- 
  tibble( lhs = labels( lhs(rules) ), 
          rhs = labels( rhs(rules) ), 
          lift = (quality(rules) %>% pull(lift))) %>%
  arrange(-lift)
rules_tib
```
