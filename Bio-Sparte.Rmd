---
title: "Bio-Sparte"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

library aufrufen das wir nutzen wollen

```{r setup}
#install.packages("RPostgreSQL")
#install.packages("tidyverse")

library(DBI)
library(tidyverse)
require("RPostgreSQL")
```

Datanbankverbindung aufbauen

```{r}
DB_HOST='86.119.36.94' #or 86.119.36.94 or server2053.cs.technik.fhnw.ch
DB_PORT = 5432
DB_DBNAME = 'warenkorb_db' # or 'warenkorb_db'
DB_USERNAME = 'db_user' 
DB_PASSWORD = 'db_user_pw'

con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "PostgreSQL Unicode(x64)",
                      Server   = DB_HOST,
                      Database = DB_DBNAME,
                      UID      = DB_USERNAME,
                      PWD      = DB_PASSWORD,
                      Port     = DB_PORT,
											encoding = "latin1" )
```

Definition von tabellen auf variabeln in R um damit umzugehen

```{r}
t_products <- tbl(con, "product")
t_products <- as.data.frame(t_products)

t_aisles <- tbl(con, "aisle")
t_aisles <- as.data.frame(t_aisles)

t_departments <- tbl(con, "department")
t_departments <- as.data.frame(t_departments)

t_orders <- tbl(con, "orders")
t_orders <- as.data.frame(t_orders)

#t_orders_prior <- tbl(con, "orders_product_prior")
#t_orders_prior <- as.data.frame("t_orders_prior")

t_orders_train <- tbl(con, "orders_product_train")
t_orders_train <- as.data.frame(t_orders_train)


#t_products <- dbGetQuery(con,  "SELECT * From product")
#t_aisles <- dbGetQuery(con,  "SELECT * From aisle")
#t_departments <- dbGetQuery(con,  "SELECT * From department")
#t_orders <- dbGetQuery(con,  "SELECT * From orders")
#t_orders_prior <- dbGetQuery(con,  "SELECT * From orders_product_prior")
#t_orders_train <- dbGetQuery(con,  "SELECT * From orders_product_train")
```
Wir wollen die Anzahl and organische produkte und nicht organische produkte erhalten und aufzeigen

```{r}
t_organic_products <- t_products %>% 
  select(product_name) %>%
  filter(str_detect(tolower(product_name), pattern = "organic"))

t_notorganic_products <- t_products %>% 
  select(product_name) %>%
  filter(!str_detect(tolower(product_name), pattern = "organic"))

organic_count <- tally(t_organic_products)
notorganic_count <- tally(t_notorganic_products)
```

Kontrolle ob es fehlende werte gibt in der tabelle t_aisles

```{r}
#RETURNS INTEGER, SLOWER
t_aisles %>% 
	pull(aisle) %>% 
	is.na() %>% 
	sum()

#RETURNS LIST, FASTER
t_aisles %>%
  filter(is.na(aisle)) %>%
	count()

t_aisles %>%
  filter(is.na(aisle_id)) %>%
	count()

#only works with tabellen
t_aisles %>% 
	mutate(aisle_id_NA = is.na(aisle_id)) %>% 
	summarise(aisle_id_NA_sum = sum(aisle_id_NA))
```

```{r}
t_departments %>%
  filter(is.na(department)) %>%
	count()

t_departments %>%
  filter(is.na(department_id)) %>%
	count()
```

```{r}
t_orders %>%
  filter(is.na(orders_id)) %>%
	count()

t_orders %>%
  filter(is.na(user_id)) %>%
	count()

t_orders %>%
  filter(is.na(eval_set)) %>%
	count()

t_orders %>%
  filter(is.na(order_number)) %>%
	count()

t_orders %>%
  filter(is.na(order_dow)) %>%
	count()

t_orders %>%
  filter(is.na(order_hour_of_day)) %>%
	count()

t_orders %>%
  filter(is.na(days_since_prior_order)) %>%
	count()

missing_prior_orders <- t_orders %>% 
	pull(days_since_prior_order) %>% 
	is.na() %>% 
	sum()

x <- t_orders %>% 
	summarize(n())
#x <- tally(t_orders) #geht auch

x <- as.data.frame(x)
number_orders_tot <- as.integer(x[[1]])

missing_prior_prozent <- round(100*missing_prior_orders/number_orders_tot, 10)
```

### Kunden die zum ersten ma einkaufen
Es fehlen `r missing_prior_orders` werte von `r number_orders_tot` für days_since_prior (`r missing_prior_prozent`% . 

Es könnten first-time Kunden sein, also die Kunden die ihre erste Bestellung machen

```{r}
t_products %>%
  filter(is.na(product_id))

t_products %>%
  filter(is.na(product_name))
```

Jetzt wollen wir graphisch das verhältnis von Bio zu nicht Bio aufzeichnen
Changes Mario und Riccard:

```{r}
org_notorg <- t_products %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(organic) %>%
  count() %>%
  mutate(n = as.integer(n))

ggplot(org_notorg) +
  geom_col(aes(x = organic, y = n))

```



### Verhältnis Bio/Nicht-bio in departments & aisles
```{r, fig.height = 7}
Verhalt_dep <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(department, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	arrange(-anzahl_produkte)

Verhalt_dep

ggplot(Verhalt_dep) +
  geom_col(aes(x = reorder(department, anzahl_produkte) ,y = anzahl_produkte, fill = organic))  +
  coord_flip()
```


#change into standard dataframe


```{r, fig.height = 18}
Verhalt_aisle <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	arrange(-anzahl_produkte)

Verhalt_aisle

ggplot(Verhalt_aisle) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte), y = anzahl_produkte, fill = as.factor(organic))) +
  coord_flip()

full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	mutate(type = as.character(organic)) %>%
	ungroup() %>%
	arrange(-anzahl_produkte) %>%
	select(-organic) -> g

g

ggplot(g) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte), y = anzahl_produkte, fill = type)) +
  coord_flip()

#verhalt_aisle save or as csv
#save(Verhalt_aisle, file = "Verhalt_aisle.RData")
#write.csv(Verhalt_aisle,'Verhalt_aisle.csv')
```

```{r, fig.height = 18}
Verhalt_aisle_norg <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	filter(organic == FALSE)

Verhalt_aisle_org <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	filter(organic == TRUE)

New_Verhalt_aisle <- full_join(Verhalt_aisle_org, Verhalt_aisle_norg, "aisle") %>%
	mutate(anzahl_produkte_org = anzahl_produkte.x) %>%
	mutate(anzahl_produkte_norg = anzahl_produkte.y) %>%
	ungroup() %>%
	select(c(aisle, anzahl_produkte_org, anzahl_produkte_norg))

New_Verhalt_aisle[is.na(New_Verhalt_aisle)] <- 0

ggplot(New_Verhalt_aisle) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte_org + anzahl_produkte_norg), y = anzahl_produkte_org + anzahl_produkte_norg)) +
  coord_flip()

```


### Determine most bought products

```{r}
most_bought_all <- full_join(t_products, t_orders_train, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(organic) %>%
	count(product_name) %>%
  mutate(n = as.integer(n)) %>%
	arrange(-n) %>%
	head(30)

most_bought_all

ggplot(most_bought_all) +
  geom_col(aes(x = reorder(product_name, n), y = n, fill = organic)) +
  coord_flip()
```

#### Determine most bought organic products
```{r}
most_bought_org <- full_join(t_products, t_orders_train, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 1) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n) %>%
	head(30)

most_bought_org

ggplot(most_bought_org) +
  geom_col(aes(x = reorder(product_name, n), y = n)) +
  coord_flip()
```

#### Determine most bought non-organic products
```{r}
most_bought_nonorg <- full_join(t_products, t_orders_train, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 0) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n) %>%
	head(30)

most_bought_nonorg

ggplot(most_bought_nonorg) +
  geom_col(aes(x = reorder(product_name, n), y = n)) +
  coord_flip()
```


## A priori Algorithmus





```{r}
# close the connection (don't forget to cleanup)
dbDisconnect(con)
dbUnloadDriver(drv)
```



