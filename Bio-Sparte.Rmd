---
title: "Bio-Sparte"
output:
  html_notebook: default
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

### Libraries
Library aufrufen das wir nutzen wollen und Connection

```{r setup, include = FALSE}
require("RPostgreSQL")
source('DbConnection.R')
```

Wir möchten graphisch das verhältnis von Bio- zu nicht Bio-Produkte aufzeichnen

```{r, echo=FALSE}
org_notorg <- products %>%
  group_by(is_organic) %>%
  count() %>%
  mutate(n_produkte = as.integer(n)) %>%
  ungroup(is_organic) %>%
  mutate(is_organic = as.character(is_organic)) %>%
  select(c(is_organic, n_produkte)) %>%
  as.tibble()

org_notorg

# Create a basic bar
ggplot(org_notorg, aes(x = "", y = n_produkte, fill = is_organic)) + geom_bar(stat = "identity", width = 1) +
  # Convert to pie (polar coordinates) and add labels
  coord_polar("y", start = 0) + 
  geom_text(aes(label = paste0(round(n_produkte))), position = position_stack(vjust = 0.5)) + 
  # Add color scale (hex colors)
  scale_fill_manual(values = c("#AAAAAA", "#AAFFAA")) +
  # Remove labels and add title
  labs(x = NULL, y = NULL,  title = "Anzahl Bio-/Nicht-Produkte") +
  # Tidy up the theme
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5, color = "#666666"))
```

### Anzahl Gekaufte Bio-Produkte in Gegensatz zu nicht Bio-Produkte

```{r, echo=FALSE}
proportion_bio_sold <- full_join(products, orders, "product_id") %>%
	select(c(product_id, product_name, orders_id, is_organic)) %>%
  group_by(is_organic) %>%
	count(is_organic) %>%
  ungroup(is_organic) %>%
  mutate(is_organic = as.character(is_organic)) %>%
  mutate(n = as.integer(n)) %>%
  as.tibble()

proportion_bio_sold

# Create a basic bar
ggplot(proportion_bio_sold, aes(x = "", y = n, fill = is_organic)) + geom_bar(stat = "identity", width = 1) +
  # Convert to pie (polar coordinates) and add labels
  coord_polar("y", start = 0) + 
  geom_text(aes(label = paste0(round(n))), position = position_stack(vjust = 0.5)) + 
  # Add color scale (hex colors)
  scale_fill_manual(values=c("#AAAAAA", "#AAFFAA")) +
  # Remove labels and add title
  labs(x = NULL, y = NULL,  title = "Anzahl Verkäufte Bio-/Nicht-Produkte") +
  # Tidy up the theme
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5, color = "#666666"))  
```

### Beliebheit der Bio-Produkte in den Departments

```{r, echo=FALSE}
product_sold_dep_proportion <- full_join(t_products, t_orders_product, "product_id") %>%
  right_join(t_departments, "department_id") %>%
	select(c(product_id, product_name, orders_id, department)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(department) %>%
	count(organic) %>%
  mutate(n = as.integer(n)) %>%
  collect() %>%
  spread(key = organic, value = n) %>%
  rename(sold_organic = "1", sold_notorganic = "0") %>%
  mutate(sold_organic = replace_na(sold_organic, 0)) %>%
  mutate(tot_sold_dep = sold_organic + sold_notorganic) %>%
  mutate(sold_bio_percent = round(100*sold_organic/tot_sold_dep, digits = 2)) %>%
  arrange(desc(sold_bio_percent))

#product_sold_dep_proportion

ggplot(product_sold_dep_proportion, aes(x = reorder(department, sold_bio_percent), y = sold_bio_percent)) +
  labs(x = "department", y = "sold_bio_prozent",  title = "Prozentanzahl gekaufte Bio-Produkte per Department") +
  geom_col(fill="orange") +
  geom_text(aes(label = paste0(sold_bio_percent, "%")), position = position_stack(vjust = 0.5)) + 
  coord_flip()
```

```{r, fig.height = 17, include = FALSE}
#product_sold_aisle_proportion

product_sold_aisle_proportion <- full_join(t_products, t_orders_product, "product_id") %>%
  right_join(t_aisles, "aisle_id") %>%
	select(c(product_id, product_name, orders_id, aisle)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle) %>%
	count(organic) %>% 
  mutate(n = as.integer(n)) %>%
  collect() %>%
  spread(key = organic, value = n) %>%
  rename(sold_organic = "1", sold_notorganic = "0") %>%
  mutate(sold_organic = replace_na(sold_organic, 0)) %>%
  mutate(tot_sold_aisle = sold_organic + sold_notorganic) %>%
  mutate(sold_bio_percent = round(100*sold_organic/tot_sold_aisle, digits = 2)) %>%
  arrange(desc(sold_bio_percent))

product_sold_aisle_proportion

ggplot(product_sold_aisle_proportion, aes(x = reorder(aisle, sold_bio_percent), y = sold_bio_percent)) +
  labs(x = "department", y = "sold_bio_percent",  title = "Prozentanzahl gekaufte Bio-Produkte per Department") +
  geom_col(position = 'fill') +
  geom_text(aes(label = paste0(sold_bio_percent, "%")), position = position_stack(vjust = 0.5)) + 
  coord_flip()
```

<<<<<<< Updated upstream
### Verhältnis anzahl Bio/Nicht-bio Produkte in departments & aisles

Wir möchten auch Visualizieren was die Verhältnisse sind, zwischen die Offerte an Bio-produkte in den verschiedene Departments.  
=======
### Verhältnis Bio/Nicht-bio in departments & aisles

Wir möchten auch Visualizieren was die Verhältnisse sind, zwischen die Offerte an Bio-produkte in den verschiedene Departments und Aisles. 
>>>>>>> Stashed changes

```{r, fig.height = 7, echo=FALSE}
#proportion products per departments

proportion_dep <- full_join(t_products, t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(department, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
  collect() %>%
  spread(key = organic, value = anzahl_produkte) %>%
  rename(prod_organic = "1", prod_notorganic = "0") %>%
  mutate(prod_organic = replace_na(prod_organic, 0)) %>%
  mutate(tot_prod_dep = prod_organic + prod_notorganic) %>%
  mutate(prod_bio_percent = round(100*prod_organic/tot_prod_dep, digits = 2)) %>%
  arrange(desc(prod_bio_percent))

#proportion_dep

ggplot(proportion_dep, aes(x = reorder(department, prod_bio_percent), y = prod_bio_percent)) +
  labs(x = "department", y = "prod_bio_percent",  title = "Prozentanzahl Bio-Produkte per Department") +
  geom_col(fill="orange") +
  geom_text(aes(label = paste0(prod_bio_percent, "%")), position = position_stack(vjust = 0.5)) + 
  coord_flip()
```

Man kann sehen das die Anzahl an Bio-Produkte in den Departments sehr swach ist, im gegensatz zu den "normalen"  Produkten. 

Wir möchten auch Visualizieren was die Verhältnisse sind, zwischen die Offerte an Bio-produkte in den verschiedene Departments in relation zu die Produktauswahl. 

```{r, , fig.height = 9, echo=FALSE}
#Visulaziation between products available and products sales

table_proddep_over_propsold <- full_join(product_sold_dep_proportion, proportion_dep, "department") %>%
  select(department, sold_bio_percent, prod_bio_percent) %>%
  gather(`sold_bio_percent`, `prod_bio_percent`, key = "prod_or_sold", value = "percent") %>%
  arrange(department)

#table_proddep_over_propsold

ggplot(table_proddep_over_propsold, aes(x = reorder(department, percent), y = percent, fill = prod_or_sold)) +
  labs(x = "department", y = "bio_prozent",  title = "Prozentanzahl gekaufte Bio-Produkte per Department") +
  geom_col(position = "dodge") +
  #geom_text(aes(label = paste0(percent, "%")), position = position_stack(vjust = 0.5)) + 
  coord_flip()
```


```{r, fig.height = 17, include=FALSE}
Verhalt_aisle <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
  ungroup() %>%
	arrange(-anzahl_produkte)

#Verhalt_aisle

ggplot(Verhalt_aisle) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte), y = anzahl_produkte, fill = organic)) +
  coord_flip()

#verhalt_aisle save or as csv
#save(Verhalt_aisle, file = "Verhalt_aisle.RData")
#write.csv(Verhalt_aisle,'Verhalt_aisle.csv')
```

Man kann auch hier sehen das der Verhältniss zwischen Bio-Produkten und nicht Bio_Produkten niedrig ist in spezifische aisles. Es gibt sogar aisles wo es keinlerei Bio-Produkten gibt. Dafür aber gibt es andere aisles wo der Verhältnis viel grösser ist, z.b. Baby Food Formulas und Fresh Vegetables. 

```{r, fig.height = 18, include=FALSE}
Verhalt_aisle_norg <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	filter(organic == FALSE)

Verhalt_aisle_org <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	filter(organic == TRUE)

New_Verhalt_aisle <- full_join(Verhalt_aisle_org, Verhalt_aisle_norg, "aisle") %>%
	mutate(anzahl_produkte_org = anzahl_produkte.x) %>%
	mutate(anzahl_produkte_norg = anzahl_produkte.y) %>%
	ungroup() %>%
	select(c(aisle, anzahl_produkte_org, anzahl_produkte_norg)) %>%
	mutate(anzahl_produkte_org = as.integer(anzahl_produkte_org))

New_Verhalt_aisle[is.na(New_Verhalt_aisle)] <- as.integer(0)

New_Verhalt_aisle

ggplot(New_Verhalt_aisle) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte_org + anzahl_produkte_norg), y = anzahl_produkte_org + anzahl_produkte_norg)) +
	#scale_colour_manual(values = c("anzahl_produkte_org" = "#E08214", "anzahl_produkte_norg" = "#A08214"))+
	
	#https://stackoverflow.com/questions/6919025/how-to-assign-colors-to-categorical-variables-in-ggplot2-that-have-stable-mappin
	
  coord_flip()
```


### Determine most bought products

Wir möchten wissen welche Produkte am meisten eingekauft werden und ob diese Organic oder nicht sind

```{r, echo=FALSE}
most_bought_all <- full_join(t_products, t_orders_product, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(organic) %>%
	count(product_name) %>%
  mutate(n = as.integer(n)) %>%
	arrange(-n) %>%
	head(30)

most_bought_all

ggplot(most_bought_all) +
  geom_col(aes(x = reorder(product_name, n), y = n, fill = organic)) +
  coord_flip()
```


```{r, include=FALSE}
# Determine most bought organic products

most_bought_org <- full_join(t_products, t_orders_product, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 1) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n) %>%
	head(30)

most_bought_org

ggplot(most_bought_org) +
  geom_col(aes(x = reorder(product_name, n), y = n)) +
  coord_flip()
```

```{r, include=FALSE}
#Most bought non-organic products

most_bought_nonorg <- full_join(t_products, t_orders_product, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 0) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n) %>%
	head(30) %>%
  as_tibble()

most_bought_nonorg

ggplot(most_bought_nonorg) +
  geom_col(aes(x = reorder(product_name, n), y = n)) +
  coord_flip()
```



## Stammkunden analyse

Ein ziele wäre die Stammkunden erkennen und sehen ob sie verschieden einkaufen, z.b eine höhere Anzahl an Produkten pro Bestellung kaufen. Daher haben wir der durschnitt an Bestellungen berechnet sowie die Quartilen: Ausser dem Visualizieren wir mit einen Plot die Anzahl kunden die Mehrmals bei uns eingekauft haben. 

```{r, echo=FALSE}
order_number_range_client <- t_orders %>% 
  group_by(orders_id) %>%
  summarise(nr_of_orders = last(order_number)) %>%
	count(nr_of_orders)

order_range_client <- t_orders %>% 
  group_by(orders_id) %>%
  summarise(nr_of_orders = last(order_number))

order_number_range_client
#order_range_client

ggplot(data = order_number_range_client) + 
  geom_col(mapping = aes(x = nr_of_orders, y = n), width=0.9, fill = "#FF9999") +
  xlab("nr_of_orders") + ylab("Nr of clients") +
	coord_cartesian(xlim = c(0,50)) +
  ggtitle("Number of clients with same order count") 

mean_range_clients_size <- mean(order_range_client$nr_of_orders)
quantile_range_clients_size <- quantile(order_range_client$nr_of_orders)

mean_range_clients_size
quantile_range_clients_size
```

Wir wollen auch den Durschnitt von Bestellung von jeden Kunden Berechnen. 

```{r, echo=FALSE}
order_freq <- t_orders %>% 
  group_by(user_id) %>%
	na.omit %>%
	mutate(mean_freq = mean(days_since_prior_order)) %>%
	summarise(mean_freq = last(mean_freq)) %>%
	mutate(mean_freq = as.integer(mean_freq)) 
	
#order_freq

ggplot(data = order_freq) + 
  geom_bar(mapping = aes(x = mean_freq), width = 0.9, fill = "#FF9999") +
  xlab("clients buy every n days") + ylab("Nr of clients") +
  ggtitle("Average frequency of days since last order")

#Maixmale anzahl tage zwischen einkäufe
max_days_since_last_for_stamm <- 14
```

Wir definieren Stammkunden die die mindestens einmal alle `r max_days_since_last_for_stamm` Tagen bei uns einkaufen (Alle `r max_days_since_last_for_stamm` Tage, im diagramm 0 bis `r max_days_since_last_for_stamm-1`)

```{r, echo=FALSE}
Anzahl_stammkunden <- order_freq %>%
	filter(mean_freq <= max_days_since_last_for_stamm) %>%
	count()
Tot_kunden <- order_freq %>%
	count()

Anzahl_stammkunden <- Anzahl_stammkunden$n
Tot_kunden <- Tot_kunden$n
Prozent_stamm <- 100*Anzahl_stammkunden/Tot_kunden
```

Die totale anzahl an stammkunden ist `r Anzahl_stammkunden` von `r Tot_kunden`. Dies entsprecht `r Prozent_stamm`% von  aller Kunden die je im laden waren

```{r, echo=FALSE}
#Create a new table with Order_id and nr_of_items per order
items_per_order <- t_orders_product %>% 
  group_by(orders_id) %>%
  summarise(nr_of_items = last(add_to_cart_order)) %>%
	arrange(orders_id)

#items_per_order

#count the total number of bought items
tot_num_transactions <- items_per_order %>%
	select(nr_of_items) %>%
	sum()

#join items_per_order table and order_freq over t_orders table
frankenstein <- left_join(order_freq, t_orders, "user_id") %>%
	left_join(items_per_order, "orders_id") %>%
	na.omit() %>%
	select(-c(eval_set, order_dow, order_hour_of_day, order_number, days_since_prior_order)) %>%
	filter(mean_freq <= max_days_since_last_for_stamm) %>%
	group_by(nr_of_items)

#resulting table is 
#frankenstein

ggplot(data = frankenstein) + 
  geom_bar(mapping = aes(x = nr_of_items), width = 0.9, fill = "#FF9999") +
  xlab("Number of items per client") + ylab("Nr of clients")

#count the toal number of bought items for stammkunden
Num_of_transactions_stamm <- frankenstein %>%
	select(nr_of_items) %>%
	sum()

#Num_of_transactions_stamm
#tot_num_transactions

Perzent_trans_stamm <- 100*Num_of_transactions_stamm/tot_num_transactions
#Perzent_trans_stamm
```
Die Anzahl an transactionen das von Stammkunden geamcht wurden entsprechen `r Num_of_transactions_stamm` von `r tot_num_transactions`. Das entspricht `r Perzent_trans_stamm`% aller transactionen. 

## A priori Algorithmus

# First Buy für Bioprodukte
```{r}
t_orders_FirstBuy_most_bought_org <- t_orders_FirstBuy %>% inner_join(t_orders_product) %>%
  inner_join(t_products) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  filter(organic == TRUE) %>%
  count(product_name) %>%
  mutate(n = as.integer(n)) %>%
	arrange(-n)
  

most_bought_org <- full_join(t_products, t_orders_product, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 1) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n)%>%
  mutate(n= n/20)
  

most_bought_org
t_orders_FirstBuy_most_bought_org

#Die Rangliste der Meistgekauften Bio-Produkte unterscheiden sich nur sehr gering von der Rangliste der insgesammt Gekauften Bio-Produkte und daher Vernachlässigbar


```

#Vergleich der Tabellen mit compare_df
```{r}
ctable_firstBuyer = compareDF::compare_df(as.data.frame(most_bought_org), as.data.frame(most_bought_nonorg), c("product_name"))

print(ctable_firstBuyer$html_output)


#ergibt einen übersichlichen Table, die n Daten können allerdings nicht ernstgenommen werden, darum veränder ich die Werte von n an die gesammte Anzahl n.
```


# wichtige Produkte die ein Bio-Äquivalent besitzen
```{r}


```




#Untersuchung des LAst-Buy
```{r, echo=FALSE, results="hide"}
#Wie verhält sich der letzte Eikauf? t_orders_lastBuy filtert alle Produkte herraus, die sich als letztes in den Warenkrob gelegt wurden.

t_orders_lastBuy<- t_orders %>% 
  group_by(orders_id) %>% 
  arrange(desc(add_to_cart_order)) %>%
  inner_join(t_products) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  collect()%>% 
  slice(1) %>% 
  ungroup()

t_orders_lastBuy

#Barplot über das Verhalten des Last Buy
#in den Gängen
ggplot(data = t_orders_lastBuy) + 
  geom_bar(mapping = aes(x = aisle_id), width = 0.9, fill = "#FF9999") +
  xlab("aisle id") + ylab("Anzahl Einkäufe")

#in den Abteilungen 
ggplot(data = t_orders_lastBuy) + 
  geom_bar(mapping = aes(x = department_id), width = 0.9, fill = "#FF9999") +
  xlab("department id") + ylab("Anzahl Einkäufe")

#ist der letzte Einkauf Bio oder nicht
ggplot(data = t_orders_lastBuy) + 
  geom_bar(mapping = aes(x = organic), width = 0.5, fill = "#FF9999") +
  xlab("Bio oder nicht Bio") + ylab("Anzahl eingekaufte Produkte")

```

```{r}
#Gesucht sich 100 Kunden mit den höchstne Kunden einkäufen, -> es gibt mehr als 100 Kunden die 100 Produkte im Warenkorb hatten

the100 <- t_orders %>%
  group_by(user_id) %>%
  count() %>%
  arrange(desc(n))%>%
  head(100) %>%
  select(user_id)

the100
t_orders
  
t_orders %>%
  inner_join(t_orders_product) %>%
  inner_join(t_products) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = department_id), width = 0.9, fill = "#FF9999") +
  xlab("department id") + ylab("Anzahl Einkäufe")

t_orders %>%
  inner_join(the100) %>%
  inner_join(t_orders_product) %>%
  inner_join(t_products) %>%
  filter(add_to_cart_order == 1) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = department_id), width = 0.9, fill = "#FF9999") +
  xlab("department id") + ylab("Anzahl Einkäufe")

#t_orders_lastBuy<- t_orders_product %>% 
  #group_by(orders_id) %>% 
  #arrange(desc(add_to_cart_order)) %>%
  #inner_join(t_products) %>%
  #mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  #collect()%>% 
  #slice(1) %>% 
  #ungroup()

t_departments
```

```{r}
ratio_products_org_notorg

```

