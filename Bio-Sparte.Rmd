---
title: "Bio-Sparte"
output:
  html_notebook: default
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

### Libraries
Library aufrufen das wir nutzen wollen

```{r setup, echo=FALSE, results="hide"}
library(DBI)
library(tidyverse)
require("RPostgreSQL")
```

### Connection
Datanbankverbindung aufbauen

```{r, echo=FALSE, results="hide"}
DB_HOST='86.119.36.94' #or 86.119.36.94 or server2053.cs.technik.fhnw.ch
DB_PORT = 5432
DB_DBNAME = 'warenkorb_db' # or 'warenkorb_db'
DB_USERNAME = 'db_user' 
DB_PASSWORD = 'db_user_pw'

con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "PostgreSQL Unicode(x64)",
                      Server   = DB_HOST,
                      Database = DB_DBNAME,
                      UID      = DB_USERNAME,
                      PWD      = DB_PASSWORD,
                      Port     = DB_PORT,
											encoding = "latin1" )
```

### Grabbing the data
Abrufen von daten um damit umzugehen

```{r, echo=FALSE, results="hide"}
t_products <- tbl(con, "product")
t_aisles <- tbl(con, "aisle")
t_departments <- tbl(con, "department")
t_orders <- tbl(con, "orders")
t_orders_prior <- tbl(con, "orders_product_prior")
t_orders_train <- tbl(con, "orders_product_train")

#t_products <- dbGetQuery(con,  "SELECT * From product")
#t_aisles <- dbGetQuery(con,  "SELECT * From aisle")
#t_departments <- dbGetQuery(con,  "SELECT * From department")
#t_orders <- dbGetQuery(con,  "SELECT * From orders")
#t_orders_prior <- dbGetQuery(con,  "SELECT * From orders_product_prior")
#t_orders_train <- dbGetQuery(con,  "SELECT * From orders_product_train")
```

Wir möchten graphisch das verhältnis von Bio- zu nicht Bio-Produkte aufzeichnen

```{r, echo=FALSE}
org_notorg <- t_products %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(organic) %>%
  count() %>%
  mutate(n_produkte = as.integer(n))

ggplot(org_notorg) +
  geom_col(aes(x = organic, y = n_produkte)) 

ggplot(org_notorg, aes(x = "", y = n_produkte, fill = organic)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0)
```

### Anzahl Gekaufte Bio-Produkte in respekt zu nicht Bio-Produkte

```{r}
Verhalt_Bio_bought <- t_products %>%
  
```



### Verhältnis Bio/Nicht-bio in departments & aisles

Wir möchten auch Visualizieren was die Verhältnisse sind, zwischen die Offerte an Bio-produkte in den verschiedene Departments und Aisles. 

```{r, fig.height = 7, echo=FALSE}
Verhalt_dep <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(department, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	arrange(-anzahl_produkte)

#Verhalt_dep

ggplot(Verhalt_dep) +
  geom_col(aes(x = reorder(department, anzahl_produkte) ,y = anzahl_produkte, fill = organic))  +
  coord_flip()
```

Man kann sehen das die Anzahl an Bio-Produkte in den Departments sehr swach ist, im gegensatz zu den "normalen"  Produkten. 

```{r, fig.height = 17, echo=FALSE}
Verhalt_aisle <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
  ungroup() %>%
	arrange(-anzahl_produkte)

#Verhalt_aisle

ggplot(Verhalt_aisle) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte), y = anzahl_produkte, fill = organic)) +
  coord_flip()

#verhalt_aisle save or as csv
#save(Verhalt_aisle, file = "Verhalt_aisle.RData")
#write.csv(Verhalt_aisle,'Verhalt_aisle.csv')
```

Man kann auch hier sehen das der Verhältniss zwischen Bio-Produkten und nicht Bio_Produkten niedrig ist in spezifische aisles. Es gibt sogar aisles wo es keinlerei Bio-Produkten gibt. Dafür aber gibt es andere aisles wo der Verhältnis viel grösser ist, z.b. Baby Food Formulas und Fresh Vegetables. 

```{r, fig.height = 18, include=FALSE}
Verhalt_aisle_norg <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	filter(organic == FALSE)

Verhalt_aisle_org <- full_join(t_products, t_aisles, "aisle_id") %>%
	full_join(t_departments, "department_id") %>%
	select(-c(aisle_id, department_id, product_id)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(aisle, organic) %>%
	count(name = "anzahl_produkte") %>%
  mutate(anzahl_produkte = as.integer(anzahl_produkte)) %>%
	filter(organic == TRUE)

New_Verhalt_aisle <- full_join(Verhalt_aisle_org, Verhalt_aisle_norg, "aisle") %>%
	mutate(anzahl_produkte_org = anzahl_produkte.x) %>%
	mutate(anzahl_produkte_norg = anzahl_produkte.y) %>%
	ungroup() %>%
	select(c(aisle, anzahl_produkte_org, anzahl_produkte_norg)) %>%
	mutate(anzahl_produkte_org = as.integer(anzahl_produkte_org))

New_Verhalt_aisle[is.na(New_Verhalt_aisle)] <- as.integer(0)

New_Verhalt_aisle

ggplot(New_Verhalt_aisle) +
  geom_col(aes(x = reorder(as.factor(aisle), anzahl_produkte_org + anzahl_produkte_norg), y = anzahl_produkte_org + anzahl_produkte_norg)) +
	#scale_colour_manual(values = c("anzahl_produkte_org" = "#E08214", "anzahl_produkte_norg" = "#A08214"))+
	
	#https://stackoverflow.com/questions/6919025/how-to-assign-colors-to-categorical-variables-in-ggplot2-that-have-stable-mappin
	
  coord_flip()
```


### Determine most bought products

Wir möchten wissen welche Produkte am meisten eingekauft werden und ob diese Organic oder nicht sind

```{r, echo=FALSE}
most_bought_all <- full_join(t_products, t_orders_train, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
	mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  group_by(organic) %>%
	count(product_name) %>%
  mutate(n = as.integer(n)) %>%
	arrange(-n) %>%
	head(30)

most_bought_all

ggplot(most_bought_all) +
  geom_col(aes(x = reorder(product_name, n), y = n, fill = organic)) +
  coord_flip()
```


```{r, include=FALSE}
# Determine most bought organic products

most_bought_org <- full_join(t_products, t_orders_product, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 1) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n) %>%
	head(30)

most_bought_org

ggplot(most_bought_org) +
  geom_col(aes(x = reorder(product_name, n), y = n)) +
  coord_flip()
```

```{r, include=FALSE}
#Most bought non-organic products

most_bought_nonorg <- full_join(t_products, t_orders_product, "product_id") %>%
	select(-c(aisle_id, department_id, index, add_to_cart_order, reordered)) %>%
  mutate(organic = str_detect(tolower(product_name), pattern = "organic")) %>%
  mutate(organic = as.integer(organic)) %>%
  filter(organic == 0) %>%
	count(product_name) %>%
  mutate(n = as.integer(n))  %>%
	arrange(-n) %>%
	head(30)

most_bought_nonorg

ggplot(most_bought_nonorg) +
  geom_col(aes(x = reorder(product_name, n), y = n)) +
  coord_flip()
```



## Stammkunden analyse

Ein ziele wäre die Stammkunden erkennen und sehen ob sie verschieden einkaufen, z.b eine höhere Anzahl an Produkten pro Bestellung kaufen. Daher haben wir der durschnitt an Bestellungen berechnet sowie die Quartilen: Ausser dem Visualizieren wir mit einen Plot die Anzahl kunden die Mehrmals bei uns eingekauft haben. 

```{r, echo=FALSE}
order_number_range_client <- t_orders %>% 
  group_by(orders_id) %>%
  summarise(nr_of_orders = last(order_number)) %>%
	count(nr_of_orders)

order_range_client <- t_orders %>% 
  group_by(orders_id) %>%
  summarise(nr_of_orders = last(order_number))

order_number_range_client
#order_range_client

ggplot(data = order_number_range_client) + 
  geom_col(mapping = aes(x = nr_of_orders, y = n), width=0.9, fill = "#FF9999") +
  xlab("nr_of_orders") + ylab("Nr of clients") +
	coord_cartesian(xlim = c(0,50)) +
  ggtitle("Number of clients with same order count") 

mean_range_clients_size <- mean(order_range_client$nr_of_orders)
quantile_range_clients_size <- quantile(order_range_client$nr_of_orders)

mean_range_clients_size
quantile_range_clients_size
```

Wir wollen auch den Durschnitt von Bestellung von jeden Kunden Berechnen. 

```{r, echo=FALSE}
order_freq <- t_orders %>% 
  group_by(user_id) %>%
	na.omit %>%
	mutate(mean_freq = mean(days_since_prior_order)) %>%
	summarise(mean_freq = last(mean_freq)) %>%
	mutate(mean_freq = as.integer(mean_freq)) 
	
#order_freq

ggplot(data = order_freq) + 
  geom_bar(mapping = aes(x = mean_freq), width = 0.9, fill = "#FF9999") +
  xlab("clients buy every n days") + ylab("Nr of clients") +
  ggtitle("Average frequency of days since last order")

#Maixmale anzahl tage zwischen einkäufe
max_days_since_last_for_stamm <- 14
```

Wir definieren Stammkunden die die mindestens einmal alle `r max_days_since_last_for_stamm` Tagen bei uns einkaufen (Alle `r max_days_since_last_for_stamm` Tage, im diagramm 0 bis `r max_days_since_last_for_stamm-1`)

```{r, echo=FALSE}
Anzahl_stammkunden <- order_freq %>%
	filter(mean_freq <= max_days_since_last_for_stamm) %>%
	count()
Tot_kunden <- order_freq %>%
	count()

Anzahl_stammkunden <- Anzahl_stammkunden$n
Tot_kunden <- Tot_kunden$n
Prozent_stamm <- 100*Anzahl_stammkunden/Tot_kunden
```

Die totale anzahl an stammkunden ist `r Anzahl_stammkunden` von `r Tot_kunden`. Dies entsprecht `r Prozent_stamm`% von  aller Kunden die je im laden waren

```{r, echo=FALSE}
#Create a new table with Order_id and nr_of_items per order
items_per_order <- t_orders_product %>% 
  group_by(orders_id) %>%
  summarise(nr_of_items = last(add_to_cart_order)) %>%
	arrange(orders_id)

#items_per_order

#count the total number of bought items
tot_num_transactions <- items_per_order %>%
	select(nr_of_items) %>%
	sum()

#join items_per_order table and order_freq over t_orders table
frankenstein <- left_join(order_freq, t_orders, "user_id") %>%
	left_join(items_per_order, "orders_id") %>%
	na.omit() %>%
	select(-c(eval_set, order_dow, order_hour_of_day, order_number, days_since_prior_order)) %>%
	filter(mean_freq <= max_days_since_last_for_stamm) %>%
	group_by(nr_of_items)

#resulting table is 
#frankenstein

ggplot(data = frankenstein) + 
  geom_bar(mapping = aes(x = nr_of_items), width = 0.9, fill = "#FF9999") +
  xlab("Number of items per client") + ylab("Nr of clients")

#count the toal number of bought items for stammkunden
Num_of_transactions_stamm <- frankenstein %>%
	select(nr_of_items) %>%
	sum()

#Num_of_transactions_stamm
#tot_num_transactions

Perzent_trans_stamm <- 100*Num_of_transactions_stamm/tot_num_transactions
#Perzent_trans_stamm
```
Die Anzahl an transactionen das von Stammkunden geamcht wurden entsprechen `r Num_of_transactions_stamm` von `r tot_num_transactions`. Das entspricht `r Perzent_trans_stamm`% aller transactionen. 


## A priori Algorithmus



```{r, echo=FALSE, results="hide"}
# close the connection (don't forget to cleanup)
dbDisconnect(con)
```



